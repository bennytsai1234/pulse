# Change: 新增播放統計與洞察 (Playback Stats & Insights)

> **ID**: `add-playback-stats`
> **狀態**: 提案中
> **建立日期**: 2026-01-05

---

## Why - 為什麼需要這個功能

### 問題陳述
目前 Pulse 缺乏使用者聆聽行為的追蹤與分析功能。使用者無法了解自己的音樂品味、最常聆聽的歌曲、每週/每月的聆聽時長等洞察資料。這是現代音樂串流服務（如 Spotify Wrapped）的標配功能。

### 使用者價值
- 📊 **個人化洞察**：了解自己的聆聽習慣與音樂品味
- 🏆 **成就感**：看到累積的聆聽統計帶來滿足感
- 🔍 **發現遺珠**：識別很久未播放的歌曲
- 📈 **趨勢追蹤**：觀察聆聽習慣的變化

---

## What Changes - 變更範圍

### 功能清單

| 功能 | 類型 | 優先級 |
|------|------|--------|
| 播放次數追蹤 | 核心 | P0 |
| 累積聆聽時長 | 核心 | P0 |
| 最常播放排行榜 | 統計 | P0 |
| 每週/每月聆聽報告 | 統計 | P1 |
| 聆聽趨勢圖表 | 視覺化 | P1 |
| 音樂品味分析 | 進階 | P2 |
| 年度回顧 (Wrapped) | 進階 | P2 |

### 核心統計指標

#### 1. 基礎指標
| 指標 | 說明 | 更新時機 |
|------|------|----------|
| **播放次數** | 完整播放（>80%）計數 | 每首歌結束時 |
| **總聆聽時長** | 累積播放秒數 | 即時更新 |
| **最後播放時間** | 最近一次播放時間戳 | 播放開始時 |
| **跳過次數** | 播放 <30s 後跳過 | 跳轉/切歌時 |

#### 2. 衍生統計
- **本週/本月聆聽時長**
- **平均每日聆聽時長**
- **最活躍時段** (早/午/晚/深夜)
- **最常聆聽藝人/專輯**
- **連續聆聽天數 (Streak)**

### UI 概覽

```
┌─────────────────────────────────────────┐
│ 📊 聆聽統計                             │
├─────────────────────────────────────────┤
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │     🎵 本週聆聽                     │ │
│ │     ████████████░░░░ 12.5 小時      │ │
│ │     比上週 +23%                     │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │     🔥 連續聆聽                     │ │
│ │     15 天                           │ │
│ │     保持下去！                      │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 🏆 最常播放                             │
│ ┌─────────────────────────────────────┐ │
│ │ 1. 歌曲名稱 - 藝人    ▶ 127 次     │ │
│ │ 2. 歌曲名稱 - 藝人    ▶ 98 次      │ │
│ │ 3. 歌曲名稱 - 藝人    ▶ 87 次      │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 📈 聆聽趨勢                             │
│ ┌─────────────────────────────────────┐ │
│ │     ▁▂▄▆█▇▅▃▂▄▆█▇▅▃                 │ │
│ │     過去 14 天                       │ │
│ └─────────────────────────────────────┘ │
│                                         │
└─────────────────────────────────────────┘
```

---

## Technical Approach - 技術方案

### 資料架構

```
┌─────────────────────────────────────────────────────────┐
│                    Room Database                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │              playback_history                    │    │
│  │  • id: Long (PK)                                │    │
│  │  • song_id: Long (FK)                           │    │
│  │  • started_at: Long (timestamp)                 │    │
│  │  • duration_played_ms: Long                     │    │
│  │  • completed: Boolean                           │    │
│  │  • skipped: Boolean                             │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │              song_stats                          │    │
│  │  • song_id: Long (PK)                           │    │
│  │  • play_count: Int                               │    │
│  │  • total_duration_ms: Long                       │    │
│  │  • skip_count: Int                               │    │
│  │  • last_played_at: Long                          │    │
│  │  • first_played_at: Long                         │    │
│  └─────────────────────────────────────────────────┘    │
│                                                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │              daily_stats                         │    │
│  │  • date: String (PK, YYYY-MM-DD)                │    │
│  │  • total_duration_ms: Long                       │    │
│  │  • song_count: Int                               │    │
│  │  • unique_songs: Int                             │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

### 實作策略
1. **播放監聽器**：在 MusicController 中加入播放狀態監聽
2. **背景記錄**：使用 WorkManager 定期彙總統計
3. **快取策略**：熱門數據快取於記憶體，減少 DB 查詢
4. **資料遷移**：提供從匯出備份導入歷史數據的選項

---

## Impact - 影響範圍

### 受影響的 Specs
- `stats` (新建) - 統計追蹤規範
- `ui-stats` (新建) - 統計 UI 規範

### 受影響的程式碼
| 模組 | 檔案/目錄 | 變更類型 |
|------|-----------|----------|
| `data` | `database/entity/PlaybackHistory.kt` | 新增 |
| `data` | `database/entity/SongStats.kt` | 新增 |
| `data` | `database/entity/DailyStats.kt` | 新增 |
| `data` | `database/dao/StatsDao.kt` | 新增 |
| `data` | `repository/StatsRepositoryImpl.kt` | 新增 |
| `domain` | `repository/StatsRepository.kt` | 新增 |
| `domain` | `usecase/stats/` | 新增 |
| `domain` | `model/PlaybackStats.kt` | 新增 |
| `player` | `MusicController.kt` | 修改 |
| `ui` | `stats/` | 新增 |

### 儲存空間評估
- 平均每天播放 50 首歌：~5KB/天
- 一年累積：~1.8MB
- 含索引總計：< 3MB

---

## Open Questions - 待決事項

1. ~~播放多久算「完整播放」？~~ → **>80% 或播放 >4 分鐘**
2. ~~跳過的定義？~~ → **播放 <30 秒後切歌**
3. 是否支援匯出統計資料？→ **Phase 2 考慮**
4. 是否同步到雲端？→ **未來擴展，目前僅本地**

---

## Success Metrics - 成功指標

- [ ] 播放記錄準確無遺漏
- [ ] 統計頁面載入時間 < 500ms
- [ ] 資料庫增長可控 (< 10MB/年)
- [ ] 統計與實際播放一致 (可驗證)
