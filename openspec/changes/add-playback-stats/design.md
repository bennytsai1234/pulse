# Design: æ’­æ”¾çµ±è¨ˆèˆ‡æ´å¯ŸæŠ€è¡“è¨­è¨ˆ

> **Change ID**: `add-playback-stats`
> **ç‰ˆæœ¬**: 1.0
> **å»ºç«‹æ—¥æœŸ**: 2026-01-05

---

## 1. ç³»çµ±æ¶æ§‹

### 1.1 å…ƒä»¶åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          UI Layer                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    StatsScreen                           â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚ Overview    â”‚ â”‚ Top Songs   â”‚ â”‚ Trend Chart    â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ Cards       â”‚ â”‚ List        â”‚ â”‚ (Compose)      â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    StatsViewModel                        â”‚    â”‚
â”‚  â”‚  â€¢ overviewStats: StateFlow<OverviewStats>              â”‚    â”‚
â”‚  â”‚  â€¢ topSongs: StateFlow<List<SongStats>>                 â”‚    â”‚
â”‚  â”‚  â€¢ trendData: StateFlow<List<DailyStats>>               â”‚    â”‚
â”‚  â”‚  â€¢ currentStreak: StateFlow<Int>                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Domain Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      UseCases                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ RecordPlayback  â”‚  â”‚ GetOverviewStats             â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ UseCase         â”‚  â”‚ UseCase                      â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ GetTopSongs     â”‚  â”‚ GetListeningTrend            â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ UseCase         â”‚  â”‚ UseCase                      â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚ GetCurrentStreakâ”‚  â”‚ GetUnplayedSongs             â”‚    â”‚  â”‚
â”‚  â”‚  â”‚ UseCase         â”‚  â”‚ UseCase                      â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Data Layer                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚               StatsRepositoryImpl                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                      StatsDao                            â”‚    â”‚
â”‚  â”‚  + insertPlaybackRecord(record)                         â”‚    â”‚
â”‚  â”‚  + updateSongStats(songId, ...)                         â”‚    â”‚
â”‚  â”‚  + getTopPlayedSongs(limit): Flow<List<SongStats>>      â”‚    â”‚
â”‚  â”‚  + getDailyStats(startDate, endDate): Flow<...>         â”‚    â”‚
â”‚  â”‚  + getTotalListeningTime(): Flow<Long>                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Room Database                         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚ playback_    â”‚ â”‚ song_stats   â”‚ â”‚ daily_stats  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ history      â”‚ â”‚              â”‚ â”‚              â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Player Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚               PlaybackTracker                            â”‚    â”‚
â”‚  â”‚  + onPlaybackStarted(song)                              â”‚    â”‚
â”‚  â”‚  + onPlaybackProgress(position, duration)               â”‚    â”‚
â”‚  â”‚  + onPlaybackEnded(completed, skipped)                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è³‡æ–™æµ - æ’­æ”¾è¿½è¹¤

```
User plays a song
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MusicController â”‚
â”‚ onPlayStart()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PlaybackTracker â”‚
â”‚ startSession()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create          â”‚
â”‚ PlaybackRecord  â”‚
â”‚ (in-memory)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼
 Song ends   Song skipped
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Calculate       â”‚
â”‚ completion %    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Persist to      â”‚
â”‚ Room Database   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update          â”‚
â”‚ song_stats &    â”‚
â”‚ daily_stats     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. è³‡æ–™æ¨¡å‹

### 2.1 Room Entities

```kotlin
@Entity(tableName = "playback_history")
data class PlaybackHistoryEntity(
    @PrimaryKey(autoGenerate = true)
    val id: Long = 0,

    @ColumnInfo(name = "song_id")
    val songId: Long,

    @ColumnInfo(name = "started_at")
    val startedAt: Long,  // Unix timestamp ms

    @ColumnInfo(name = "duration_played_ms")
    val durationPlayedMs: Long,

    @ColumnInfo(name = "song_duration_ms")
    val songDurationMs: Long,

    @ColumnInfo(name = "completed")
    val completed: Boolean,

    @ColumnInfo(name = "skipped")
    val skipped: Boolean
)

@Entity(tableName = "song_stats")
data class SongStatsEntity(
    @PrimaryKey
    @ColumnInfo(name = "song_id")
    val songId: Long,

    @ColumnInfo(name = "play_count")
    val playCount: Int = 0,

    @ColumnInfo(name = "total_duration_ms")
    val totalDurationMs: Long = 0,

    @ColumnInfo(name = "skip_count")
    val skipCount: Int = 0,

    @ColumnInfo(name = "last_played_at")
    val lastPlayedAt: Long = 0,

    @ColumnInfo(name = "first_played_at")
    val firstPlayedAt: Long = 0
)

@Entity(tableName = "daily_stats")
data class DailyStatsEntity(
    @PrimaryKey
    @ColumnInfo(name = "date")
    val date: String,  // YYYY-MM-DD

    @ColumnInfo(name = "total_duration_ms")
    val totalDurationMs: Long = 0,

    @ColumnInfo(name = "song_count")
    val songCount: Int = 0,

    @ColumnInfo(name = "unique_songs")
    val uniqueSongs: Int = 0
)
```

### 2.2 Domain Models

```kotlin
@Immutable
data class OverviewStats(
    val totalListeningTimeMs: Long,
    val totalSongsPlayed: Int,
    val totalUniqueSongs: Int,
    val weeklyListeningTimeMs: Long,
    val weeklyChangePercent: Float,
    val mostActiveHour: Int,  // 0-23
    val currentStreak: Int
)

@Immutable
data class SongPlayStats(
    val song: Song,
    val playCount: Int,
    val totalListeningTimeMs: Long,
    val skipCount: Int,
    val lastPlayedAt: Long,
    val completionRate: Float  // playCount / (playCount + skipCount)
)

@Immutable
data class ListeningTrend(
    val date: LocalDate,
    val durationMs: Long,
    val songCount: Int
)
```

---

## 3. æ ¸å¿ƒæ¼”ç®—æ³•

### 3.1 æ’­æ”¾å®Œæˆåˆ¤å®š

```kotlin
object PlaybackCompletionRules {
    const val COMPLETION_THRESHOLD = 0.8f  // 80%
    const val MIN_DURATION_FOR_LONG_SONG_MS = 240_000L  // 4 minutes
    const val SKIP_THRESHOLD_MS = 30_000L  // 30 seconds

    fun isCompleted(playedMs: Long, totalMs: Long): Boolean {
        val percentage = playedMs.toFloat() / totalMs
        return percentage >= COMPLETION_THRESHOLD ||
               playedMs >= MIN_DURATION_FOR_LONG_SONG_MS
    }

    fun isSkipped(playedMs: Long): Boolean {
        return playedMs < SKIP_THRESHOLD_MS
    }
}
```

### 3.2 é€£çºŒè†è½å¤©æ•¸ (Streak) è¨ˆç®—

```kotlin
suspend fun calculateCurrentStreak(): Int {
    val today = LocalDate.now()
    var streak = 0
    var checkDate = today

    while (true) {
        val hasListening = dailyStatsDao.hasListeningOnDate(
            checkDate.format(DateTimeFormatter.ISO_DATE)
        )

        if (hasListening) {
            streak++
            checkDate = checkDate.minusDays(1)
        } else if (checkDate == today) {
            // Today might not have listening yet, check yesterday
            checkDate = checkDate.minusDays(1)
        } else {
            break
        }
    }

    return streak
}
```

### 3.3 é€±è®ŠåŒ–ç™¾åˆ†æ¯”è¨ˆç®—

```kotlin
fun calculateWeeklyChange(
    thisWeekMs: Long,
    lastWeekMs: Long
): Float {
    if (lastWeekMs == 0L) return 0f
    return ((thisWeekMs - lastWeekMs).toFloat() / lastWeekMs) * 100
}
```

---

## 4. DAO è¨­è¨ˆ

```kotlin
@Dao
interface StatsDao {
    // Playback History
    @Insert
    suspend fun insertPlaybackRecord(record: PlaybackHistoryEntity)

    // Song Stats
    @Query("""
        INSERT OR REPLACE INTO song_stats
        (song_id, play_count, total_duration_ms, skip_count, last_played_at, first_played_at)
        VALUES (
            :songId,
            COALESCE((SELECT play_count FROM song_stats WHERE song_id = :songId), 0) + :playCountDelta,
            COALESCE((SELECT total_duration_ms FROM song_stats WHERE song_id = :songId), 0) + :durationDelta,
            COALESCE((SELECT skip_count FROM song_stats WHERE song_id = :songId), 0) + :skipCountDelta,
            :lastPlayedAt,
            COALESCE((SELECT first_played_at FROM song_stats WHERE song_id = :songId), :lastPlayedAt)
        )
    """)
    suspend fun upsertSongStats(
        songId: Long,
        playCountDelta: Int,
        durationDelta: Long,
        skipCountDelta: Int,
        lastPlayedAt: Long
    )

    // Top Songs
    @Query("""
        SELECT ss.*, s.* FROM song_stats ss
        INNER JOIN songs s ON ss.song_id = s.id
        ORDER BY ss.play_count DESC
        LIMIT :limit
    """)
    fun getTopPlayedSongs(limit: Int): Flow<List<SongWithStats>>

    // Daily Stats
    @Query("""
        SELECT * FROM daily_stats
        WHERE date BETWEEN :startDate AND :endDate
        ORDER BY date ASC
    """)
    fun getDailyStats(startDate: String, endDate: String): Flow<List<DailyStatsEntity>>

    // Aggregations
    @Query("SELECT SUM(total_duration_ms) FROM song_stats")
    fun getTotalListeningTime(): Flow<Long?>

    @Query("""
        SELECT SUM(total_duration_ms) FROM daily_stats
        WHERE date >= :startDate AND date <= :endDate
    """)
    suspend fun getListeningTimeInRange(startDate: String, endDate: String): Long?

    // Streak
    @Query("SELECT EXISTS(SELECT 1 FROM daily_stats WHERE date = :date AND song_count > 0)")
    suspend fun hasListeningOnDate(date: String): Boolean

    // Unplayed songs (for discovery)
    @Query("""
        SELECT s.* FROM songs s
        LEFT JOIN song_stats ss ON s.id = ss.song_id
        WHERE ss.song_id IS NULL OR ss.last_played_at < :beforeTimestamp
        ORDER BY RANDOM()
        LIMIT :limit
    """)
    fun getUnplayedOrOldSongs(beforeTimestamp: Long, limit: Int): Flow<List<Song>>
}
```

---

## 5. UI è¨­è¨ˆè©³ç´°

### 5.1 çµ±è¨ˆé¦–é çµæ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† è†è½çµ±è¨ˆ                                    â‹® (é¸å–®) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ğŸ“Š æœ¬é€±è†è½          â”‚  â”‚ ğŸ”¥ é€£çºŒå¤©æ•¸          â”‚      â”‚
â”‚  â”‚                     â”‚  â”‚                     â”‚      â”‚
â”‚  â”‚   12.5 å°æ™‚         â”‚  â”‚    15 å¤©            â”‚      â”‚
â”‚  â”‚   â–² +23% vs ä¸Šé€±   â”‚  â”‚    æ­·å²æœ€é«˜: 32 å¤©  â”‚      â”‚
â”‚  â”‚                     â”‚  â”‚                     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸµ ç¸½è†è½æ™‚é•·                                    â”‚   â”‚
â”‚  â”‚                                                  â”‚   â”‚
â”‚  â”‚   342 å°æ™‚ 15 åˆ†é˜                              â”‚   â”‚
â”‚  â”‚   ç´„ç­‰æ–¼ 14.3 å¤©                                 â”‚   â”‚
â”‚  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœ€å¸¸æ’­æ”¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ¥‡ æ­Œæ›²åç¨±                                      â”‚   â”‚
â”‚  â”‚    è—äººåç¨± â€¢ å°ˆè¼¯åç¨±                          â”‚   â”‚
â”‚  â”‚    â–¶ 127 æ¬¡æ’­æ”¾ â€¢ å…± 8.2 å°æ™‚                   â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ ğŸ¥ˆ æ­Œæ›²åç¨±                                      â”‚   â”‚
â”‚  â”‚    è—äººåç¨± â€¢ å°ˆè¼¯åç¨±                          â”‚   â”‚
â”‚  â”‚    â–¶ 98 æ¬¡æ’­æ”¾ â€¢ å…± 6.1 å°æ™‚                    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ ğŸ¥‰ æ­Œæ›²åç¨±                                      â”‚   â”‚
â”‚  â”‚    è—äººåç¨± â€¢ å°ˆè¼¯åç¨±                          â”‚   â”‚
â”‚  â”‚    â–¶ 87 æ¬¡æ’­æ”¾ â€¢ å…± 5.4 å°æ™‚                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                               æŸ¥çœ‹æ›´å¤š â†’ â”‚
â”‚                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è†è½è¶¨å‹¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     ğŸ“ˆ éå» 14 å¤©                                â”‚   â”‚
â”‚  â”‚                                                  â”‚   â”‚
â”‚  â”‚  3h â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚   â”‚
â”‚  â”‚      â”‚     â–„   â–„â–„                               â”‚   â”‚
â”‚  â”‚  2h â”€â”¼â”€  â–„â–ˆâ–ˆ â–„â–ˆâ–ˆâ–ˆâ–„  â–„                          â”‚   â”‚
â”‚  â”‚      â”‚ â–„â–ˆâ–ˆâ–ˆâ–ˆâ–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„â–ˆâ–ˆâ–ˆ                         â”‚   â”‚
â”‚  â”‚  1h â”€â”¼â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                      â”‚   â”‚
â”‚  â”‚      â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                      â”‚   â”‚
â”‚  â”‚  0h â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚   â”‚
â”‚  â”‚      ä¸€ äºŒ ä¸‰ å›› äº” å…­ æ—¥ ä¸€ äºŒ ä¸‰ å›› äº” å…­ æ—¥  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç™¼ç¾éºç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ’ å¾ˆä¹…æ²’æ’­æ”¾çš„æ­Œæ›²                              â”‚   â”‚
â”‚  â”‚                                                  â”‚   â”‚
â”‚  â”‚  æ­Œæ›² 1 â€¢ æ­Œæ›² 2 â€¢ æ­Œæ›² 3 â€¢ +42                 â”‚   â”‚
â”‚  â”‚                                                  â”‚   â”‚
â”‚  â”‚                               [æ¢ç´¢é€™äº›æ­Œæ›²]    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 è¦–è¦ºè¨­è¨ˆè¦ç¯„

| å…ƒç´  | é¡è‰²/æ¨£å¼ |
|------|----------|
| ä¸»å¡ç‰‡èƒŒæ™¯ | `surfaceVariant` |
| æ•¸å­—æ¨™é¡Œ | `titleLarge`, `primary` è‰² |
| å‰¯æ¨™é¡Œ | `bodyMedium`, `onSurfaceVariant` |
| å¢é•·æŒ‡æ¨™ (æ­£) | `tertiary` (ç¶ è‰²èª¿) |
| æ¸›å°‘æŒ‡æ¨™ (è² ) | `error` (ç´…è‰²èª¿) |
| åœ–è¡¨æŸ±ç‹€ | `primary` æ¼¸å±¤ |
| çç‰Œåœ–ç¤º | ğŸ¥‡ğŸ¥ˆğŸ¥‰ Emoji (fallback: æ•¸å­—) |

---

## 6. æ•ˆèƒ½å„ªåŒ–

### 6.1 å¿«å–ç­–ç•¥

```kotlin
class StatsRepository @Inject constructor(
    private val statsDao: StatsDao
) {
    // å¿«å–ç†±é–€æ•¸æ“šï¼Œé¿å…é »ç¹ DB æŸ¥è©¢
    private val overviewCache = MutableStateFlow<OverviewStats?>(null)
    private val cacheValidityMs = 60_000L  // 1 minute
    private var lastCacheTime = 0L

    fun getOverviewStats(): Flow<OverviewStats> = flow {
        val now = System.currentTimeMillis()
        if (overviewCache.value != null && now - lastCacheTime < cacheValidityMs) {
            emit(overviewCache.value!!)
        } else {
            val stats = calculateOverviewStats()
            overviewCache.value = stats
            lastCacheTime = now
            emit(stats)
        }
    }
}
```

### 6.2 è³‡æ–™åº«ç´¢å¼•

```kotlin
@Entity(
    tableName = "playback_history",
    indices = [
        Index(value = ["song_id"]),
        Index(value = ["started_at"])
    ]
)
data class PlaybackHistoryEntity(...)

@Entity(
    tableName = "song_stats",
    indices = [
        Index(value = ["play_count"]),
        Index(value = ["last_played_at"])
    ]
)
data class SongStatsEntity(...)
```

### 6.3 èƒŒæ™¯å½™ç¸½

ä½¿ç”¨ WorkManager åœ¨ç©ºé–’æ™‚é–“å½™ç¸½çµ±è¨ˆï¼š

```kotlin
class StatsAggregationWorker(
    context: Context,
    params: WorkerParameters
) : CoroutineWorker(context, params) {

    override suspend fun doWork(): Result {
        // å½™ç¸½æ˜¨æ—¥çµ±è¨ˆ
        val yesterday = LocalDate.now().minusDays(1)
        statsRepository.aggregateDailyStats(yesterday)

        // æ¸…ç†è¶…é 1 å¹´çš„è©³ç´°æ’­æ”¾è¨˜éŒ„
        statsRepository.pruneOldPlaybackHistory(
            olderThan = LocalDate.now().minusYears(1)
        )

        return Result.success()
    }
}
```

---

## 7. æ¸¬è©¦ç­–ç•¥

### 7.1 å–®å…ƒæ¸¬è©¦
- `PlaybackCompletionRules` å®Œæˆ/è·³éåˆ¤å®š
- Streak è¨ˆç®—é‚è¼¯
- é€±è®ŠåŒ–ç™¾åˆ†æ¯”è¨ˆç®—

### 7.2 æ•´åˆæ¸¬è©¦
- `StatsDao` æŸ¥è©¢æ­£ç¢ºæ€§
- `StatsRepository` å¿«å–è¡Œç‚º
- æ’­æ”¾è¿½è¹¤å®Œæ•´æµç¨‹

### 7.3 UI æ¸¬è©¦
- çµ±è¨ˆå¡ç‰‡æ­£ç¢ºé¡¯ç¤º
- è¶¨å‹¢åœ–è¡¨æ¸²æŸ“
- ç©ºç‹€æ…‹è™•ç†

---

## 8. æœªä¾†æ“´å±•

1. **å¹´åº¦å›é¡§ (Wrapped)**ï¼šå¹´æœ«ç”Ÿæˆå€‹äººåŒ–è†è½å ±å‘Š
2. **ç¤¾äº¤åˆ†äº«**ï¼šåˆ†äº«çµ±è¨ˆå¡ç‰‡åˆ°ç¤¾ç¾¤åª’é«”
3. **é›²ç«¯åŒæ­¥**ï¼šè·¨è¨­å‚™åŒæ­¥çµ±è¨ˆè³‡æ–™
4. **éŸ³æ¨‚ DNA**ï¼šåˆ†æéŸ³æ¨‚å“å‘³ (ç¯€å¥ã€æƒ…ç·’ã€å¹´ä»£)
