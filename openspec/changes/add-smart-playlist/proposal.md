# Change: 新增智慧播放清單 (Smart Playlists)

> **ID**: `add-smart-playlist`
> **狀態**: 提案中
> **建立日期**: 2026-01-05

---

## Why - 為什麼需要這個功能

### 問題陳述
目前 Pulse 只支援手動建立的靜態播放清單。使用者必須逐一添加歌曲，且清單內容不會自動更新。這在音樂庫不斷增長時變得繁瑣，也無法滿足「想聽最近添加的歌」、「想聽很久沒聽的歌」等動態需求。

### 使用者價值
- 🤖 **自動化管理**：播放清單根據規則自動更新
- 🔍 **智慧發現**：發現符合特定條件的歌曲
- ⚡ **省時省力**：無需手動維護清單
- 🎯 **個人化體驗**：基於聆聽習慣的動態推薦

---

## What Changes - 變更範圍

### 功能清單

| 功能 | 類型 | 優先級 |
|------|------|--------|
| 系統預設智慧清單 | 核心 | P0 |
| 自訂智慧清單 | 核心 | P0 |
| 規則條件引擎 | 核心 | P0 |
| 多條件組合 (AND/OR) | 進階 | P1 |
| 智慧清單排序選項 | 進階 | P1 |
| 歌曲數量限制 | 進階 | P1 |
| 即時預覽 | 進階 | P2 |

### 系統預設智慧清單

| 清單名稱 | 規則 | 圖示 |
|----------|------|------|
| **最近添加** | 過去 30 天內添加的歌曲 | 🕐 |
| **最常播放** | 播放次數 Top 50 | 🔥 |
| **很久沒聽** | 超過 60 天未播放 | 💎 |
| **短歌曲** | 時長 < 3 分鐘 | ⚡ |
| **長歌曲** | 時長 > 6 分鐘 | 🎸 |
| **高評分** | 使用者評分 ≥ 4 星 | ⭐ |

### 規則條件類型

```
┌─────────────────────────────────────────────────────────┐
│                    規則條件引擎                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  📅 時間相關                                            │
│  ├── 添加日期 (在過去 N 天內 / 特定日期範圍)            │
│  ├── 最後播放 (在過去 N 天內 / 超過 N 天前)             │
│  └── 年份 (等於 / 範圍)                                 │
│                                                         │
│  🔢 數值相關                                            │
│  ├── 播放次數 (大於 / 小於 / 等於 / 範圍)               │
│  ├── 跳過次數 (大於 / 小於)                             │
│  ├── 時長 (大於 / 小於 / 範圍)                          │
│  └── 評分 (大於 / 小於 / 等於)                          │
│                                                         │
│  📝 文字相關                                            │
│  ├── 標題 (包含 / 不包含 / 開頭為)                      │
│  ├── 藝人 (等於 / 包含 / 不包含)                        │
│  ├── 專輯 (等於 / 包含 / 不包含)                        │
│  └── 類型 (等於 / 包含)                                 │
│                                                         │
│  📂 分類相關                                            │
│  ├── 資料夾路徑 (包含)                                  │
│  └── 標籤 (包含 / 不包含)                               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### UI 概覽 - 建立智慧清單

```
┌─────────────────────────────────────────┐
│ ← 建立智慧播放清單                      │
├─────────────────────────────────────────┤
│                                         │
│ 清單名稱                                │
│ ┌─────────────────────────────────────┐ │
│ │ 我的最愛短歌                        │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 圖示                                    │
│ 🎵 🎸 ⚡ 💎 🔥 🎧 💿 🎤 🎹 🥁        │
│                                         │
│ ───────────── 規則條件 ──────────────  │
│                                         │
│ 符合 [所有條件 ▼] 的歌曲               │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ [時長 ▼] [小於 ▼] [3] [分鐘 ▼]  🗑 │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ [播放次數 ▼] [大於 ▼] [5]       🗑 │ │
│ └─────────────────────────────────────┘ │
│                                         │
│           [+ 新增條件]                  │
│                                         │
│ ───────────── 排序方式 ──────────────  │
│                                         │
│ [播放次數 ▼] [降序 ▼]                  │
│                                         │
│ ───────────── 數量限制 ──────────────  │
│                                         │
│ □ 限制歌曲數量    [50]                 │
│                                         │
│ ───────────── 預覽 ────────────────── │
│                                         │
│ 符合條件：42 首歌曲                    │
│ ┌─────────────────────────────────────┐ │
│ │ 歌曲 1 - 藝人 • 2:15                │ │
│ │ 歌曲 2 - 藝人 • 2:45                │ │
│ │ 歌曲 3 - 藝人 • 1:58                │ │
│ │ ... 顯示更多                        │ │
│ └─────────────────────────────────────┘ │
│                                         │
│         [取消]        [儲存]           │
│                                         │
└─────────────────────────────────────────┘
```

---

## Technical Approach - 技術方案

### 架構概覽

```
┌─────────────────────────────────────────────────────────┐
│                    UI Layer                              │
│  ┌─────────────────────────────────────────────────┐    │
│  │           SmartPlaylistEditorScreen              │    │
│  │  • SmartPlaylistViewModel                        │    │
│  │  • RuleConditionEditor                           │    │
│  │  • LivePreview                                   │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                    Domain Layer                          │
│  ┌─────────────────────────────────────────────────┐    │
│  │              SmartPlaylistRule                   │    │
│  │  • RuleCondition (sealed class)                  │    │
│  │  • RuleOperator (enum)                           │    │
│  │  • RuleLogic (AND/OR)                            │    │
│  └─────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────┐    │
│  │         SmartPlaylistQueryEngine                 │    │
│  │  + buildQuery(rules): SqlQuery                   │    │
│  │  + evaluateSong(song, rules): Boolean            │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                    Data Layer                            │
│  ┌─────────────────────────────────────────────────┐    │
│  │           SmartPlaylistRepositoryImpl            │    │
│  │  + getSongsMatching(rules): Flow<List<Song>>     │    │
│  │  + saveSmartPlaylist(playlist): Long             │    │
│  └─────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────┐    │
│  │              Room Database                       │    │
│  │  ┌──────────────┐  ┌──────────────────────┐     │    │
│  │  │ smart_       │  │ smart_playlist_      │     │    │
│  │  │ playlists    │  │ rules                │     │    │
│  │  └──────────────┘  └──────────────────────┘     │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

### 規則查詢引擎

```kotlin
// 將規則轉換為 SQL WHERE 子句
class SmartPlaylistQueryEngine {
    fun buildWhereClause(rules: List<RuleCondition>, logic: RuleLogic): String {
        return rules.mapNotNull { rule ->
            when (rule) {
                is RuleCondition.Duration -> buildDurationClause(rule)
                is RuleCondition.PlayCount -> buildPlayCountClause(rule)
                is RuleCondition.AddedDate -> buildAddedDateClause(rule)
                is RuleCondition.Artist -> buildArtistClause(rule)
                // ...
            }
        }.joinToString(
            separator = if (logic == RuleLogic.AND) " AND " else " OR "
        )
    }
}
```

---

## Impact - 影響範圍

### 受影響的 Specs
- `playlist` (修改) - 新增智慧播放清單規範
- `ui-playlist` (修改) - 新增智慧播放清單 UI

### 受影響的程式碼
| 模組 | 檔案/目錄 | 變更類型 |
|------|-----------|----------|
| `data` | `database/entity/SmartPlaylistEntity.kt` | 新增 |
| `data` | `database/entity/SmartPlaylistRuleEntity.kt` | 新增 |
| `data` | `database/dao/SmartPlaylistDao.kt` | 新增 |
| `data` | `repository/SmartPlaylistRepositoryImpl.kt` | 新增 |
| `domain` | `model/SmartPlaylist.kt` | 新增 |
| `domain` | `model/RuleCondition.kt` | 新增 |
| `domain` | `usecase/smartplaylist/` | 新增 |
| `domain` | `SmartPlaylistQueryEngine.kt` | 新增 |
| `ui` | `playlist/smart/` | 新增 |

### 與現有功能整合
- 與「播放統計」整合：使用播放次數、跳過次數等數據
- 與「收藏功能」整合：可建立「收藏的歌曲」規則
- 與現有播放清單並存：智慧清單顯示在清單列表中

---

## Open Questions - 待決事項

1. ~~系統預設清單是否可編輯？~~ → **否，但可複製為自訂清單**
2. ~~智慧清單何時更新？~~ → **開啟時即時查詢，不快取**
3. 是否支援巢狀條件群組？→ **Phase 1 不支援，Phase 2 考慮**
4. 是否支援匯出/匯入規則？→ **未來擴展**

---

## Success Metrics - 成功指標

- [ ] 規則查詢效能 < 200ms (1000 首歌曲庫)
- [ ] 支援至少 5 種規則條件類型
- [ ] 預設智慧清單全部可用
- [ ] 自訂清單建立流程直觀易用
