# Change: 新增交叉淡入淡出播放 (Crossfade Playback)

> **ID**: `add-crossfade-playback`
> **狀態**: 實作中
> **建立日期**: 2026-01-05

---

## Why - 為什麼需要這個功能

### 問題陳述
目前 Pulse 在歌曲切換時會有明顯的停頓感，這在連續聆聽專輯或播放清單時會打斷沉浸式體驗。專業音樂播放器（如 Spotify, Poweramp, AIMP）都提供交叉淡入淡出功能，讓歌曲之間能無縫銜接。

### 使用者價值
- 🎧 **連續聆聽體驗**：歌曲間無縫過渡，如同 DJ 混音效果
- 🎛️ **個人化控制**：可調整淡入淡出時長（1-12 秒）
- 🎵 **智慧偵測**：自動跳過靜音段落，提前開始淡出
- ⚡ **無縫整合**：與現有等化器、音量正規化功能完美協作

---

## What Changes - 變更範圍

### 功能清單

| 功能 | 類型 | 優先級 |
|------|------|--------|
| 基礎交叉淡入淡出 | 核心 | P0 |
| 淡入淡出時長設定 | 設定 | P0 |
| 智慧淡出（靜音偵測） | 進階 | P1 |
| 手動跳轉時淡入淡出 | 進階 | P1 |
| 專輯連續播放模式 | 進階 | P2 |
| 淡入淡出曲線選擇 | 進階 | P2 |

### 核心功能說明

#### 1. 基礎交叉淡入淡出
當一首歌即將結束時，下一首歌開始淡入，同時當前歌曲淡出，兩首歌在過渡期間同時播放。

```
當前歌曲:  ████████████▓▓▓▒▒░░
下一首歌:              ░░▒▒▓▓████████████
                       └──淡入淡出區間──┘
```

#### 2. 進階設定選項
- **淡入淡出時長**: 1-12 秒可調
- **淡入淡出曲線**: 線性 / 指數 / S 曲線
- **觸發條件**: 自動切歌 / 手動跳轉 / 全部
- **專輯模式**: 同專輯歌曲可選擇禁用（保持原始過渡）

#### 3. 智慧淡出
自動偵測歌曲結尾的靜音段落，提前開始淡出以避免空白等待。

---

## Technical Approach - 技術方案

### 架構概覽

```
┌─────────────────────────────────────────────────────────┐
│                    MusicService                          │
│  ┌───────────────────────────────────────────────────┐  │
│  │              CrossfadeController                   │  │
│  │  ┌─────────────┐     ┌─────────────┐              │  │
│  │  │ Primary     │     │ Secondary   │              │  │
│  │  │ ExoPlayer   │ ←→  │ ExoPlayer   │              │  │
│  │  └─────────────┘     └─────────────┘              │  │
│  │         ↑                   ↑                      │  │
│  │         └───── AudioMixer ──┘                      │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 實作策略
1. **雙播放器架構**: 使用兩個 ExoPlayer 實例進行交叉播放
2. **音量控制**: 透過 `Player.setVolume()` 實現漸變效果
3. **時間同步**: 使用 `CoroutineScope` 管理淡入淡出動畫
4. **設定持久化**: 使用 DataStore 儲存使用者偏好

---

## Impact - 影響範圍

### 受影響的 Specs
- `player` - 新增交叉淡入淡出需求
- `ui-settings` (新建) - 播放設定 UI

### 受影響的程式碼
| 模組 | 檔案/目錄 | 變更類型 |
|------|-----------|----------|
| `player` | `MusicController.kt` | 修改 |
| `player` | `CrossfadeController.kt` | 新增 |
| `domain` | `usecase/crossfade/` | 新增 |
| `data` | `PlaybackSettingsRepository.kt` | 修改 |
| `ui` | `settings/playback/` | 新增 |

### 相容性考量
- 與等化器 (Equalizer) 相容
- 與音量正規化 (Volume Normalization) 相容
- 與睡眠計時器 (Sleep Timer) 相容
- 低端設備可能需要禁用以節省資源

---

## Open Questions - 待決事項

1. ~~交叉淡入淡出是否應套用到手動跳轉？~~ → **是，但可選擇性開關**
2. ~~同專輯歌曲是否應該使用無縫播放？~~ → **是，新增「專輯連續模式」選項**
3. 靜音偵測的閾值應設定為多少？建議 -45dB

---

## Success Metrics - 成功指標

- [ ] 交叉淡入淡出功能穩定運作，無音訊爆音或斷續
- [ ] 設定變更即時生效，無需重啟播放
- [ ] 記憶體使用增加 < 15MB (雙播放器)
- [ ] CPU 使用在過渡期間增加 < 5%
